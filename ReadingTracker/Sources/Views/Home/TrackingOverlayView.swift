//import SwiftUI
//import os.log
//
//@MainActor
//struct TrackingOverlayView: View {
//    @Environment(\.managedObjectContext) private var viewContext
//    // üî• SessionManagerÎ•º ÏßÅÏ†ë Í¥ÄÏ∞∞ÌïòÏßÄ ÏïäÏùå - Ï∞∏Ï°∞Îßå ÏÇ¨Ïö©
//    private let sessionManager = SessionManager.shared
//    @State private var startingPage = ""
//    @State private var showingEndSession = false
//    @State private var showingCancelConfirmation = false
//    @State private var isSessionStarted = false
//    @State private var isStartingSession = false
//    @State private var error: TrackingError?
//    @State private var finalDuration: TimeInterval = 0
//    @State private var localSessionCreated = false
//    
//    // üî• Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄÎ•º ÏúÑÌïú ÏÉÅÌÉú
//    @State private var isProcessingAction = false
//    @State private var hasInitialized = false
//    
//    // ÏôÑÏ†ÑÌïú Î°úÏª¨ ÏÉÅÌÉú Í¥ÄÎ¶¨ - SessionManagerÏùò @Published ÏÜçÏÑ±Îì§ÏùÑ Ï†ÑÌòÄ ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùå
//    @State private var localIsTracking = false
//    @State private var localIsPaused = false
//    @State private var localDistractionCount = 0
//    @State private var localTotalReadingTime: TimeInterval = 0
//    @State private var localCurrentSession: ReadingSession?
//    @State private var localStartTime: Date?
//    
//    @FocusState private var isStartingPageFocused: Bool
//    @Binding var isPresented: Bool
//    let book: Book
//    let onSessionEnded: () -> Void
//    
//    // Modern logging system
//    private let logger = Logger(subsystem: "TrackingOverlayView", category: "Session")
//    
//    var body: some View {
//        ZStack {
//            Color.white
//                .ignoresSafeArea()
//                .onTapGesture {
//                    isStartingPageFocused = false
//                }
//            
//            VStack(spacing: 0) {
//                // Minimal Header
//                HStack {
//                    if isSessionStarted {
//                        Button(action: {
//                            // üî• Ï§ëÎ≥µ ÌÅ¥Î¶≠ Î∞©ÏßÄ
//                            guard !isProcessingAction else { return }
//                            showingCancelConfirmation = true
//                        }) {
//                            Text("Ï∑®ÏÜå")
//                                .font(.body)
//                                .foregroundColor(.red)
//                        }
//                        .disabled(isProcessingAction)
//                    } else {
//                        Button(action: {
//                            logger.info("User tapped cancel button")
//                            isPresented = false
//                        }) {
//                            Text("Ï∑®ÏÜå")
//                                .font(.body)
//                                .foregroundColor(.red)
//                        }
//                    }
//                    Spacer()
//                    Text(book.title)
//                        .font(.headline)
//                        .foregroundColor(.black)
//                        .lineLimit(1)
//                    Spacer()
//                    Text("Ï∑®ÏÜå")
//                        .font(.body)
//                        .foregroundColor(.clear)
//                }
//                .padding()
//                .background(Color.white)
//                .overlay(
//                    Rectangle()
//                        .fill(Color.gray.opacity(0.2))
//                        .frame(height: 0.5),
//                    alignment: .bottom
//                )
//                
//                // Main Content
//                VStack(spacing: 40) {
//                    Spacer()
//                    
//                    // Starting Page Input (before session starts)
//                    if !isSessionStarted {
//                        VStack(spacing: 20) {
//                            Image(systemName: "book.pages")
//                                .font(.system(size: 50))
//                                .foregroundColor(Color(hex: "4CAF50"))
//                                .padding(.bottom, 20)
//                            
//                            Text("Ïñ¥Îäê ÌéòÏù¥ÏßÄÎ∂ÄÌÑ∞ ÏãúÏûëÌïòÏãúÎÇòÏöî?")
//                                .font(.title2)
//                                .fontWeight(.semibold)
//                                .foregroundColor(.black)
//                            
//                            VStack(spacing: 12) {
//                                HStack {
//                                    Text("ÌéòÏù¥ÏßÄ")
//                                        .font(.body)
//                                        .foregroundColor(.gray)
//                                    
//                                    TextField("\(book.currentPage)", text: $startingPage)
//                                        .keyboardType(.numberPad)
//                                        .font(.system(size: 24, weight: .medium))
//                                        .multilineTextAlignment(.center)
//                                        .frame(width: 100)
//                                        .padding(.vertical, 12)
//                                        .padding(.horizontal, 16)
//                                        .background(Color.gray.opacity(0.08))
//                                        .cornerRadius(12)
//                                        .focused($isStartingPageFocused)
//                                }
//                                
//                                Text("Ï±Ö ÏßÑÌñâÎ•†: \(book.currentPage) / \(book.totalPages) ÌéòÏù¥ÏßÄ")
//                                    .font(.caption)
//                                    .foregroundColor(.gray.opacity(0.8))
//                            }
//                        }
//                    }
//                    
//                    // Timer Display (after session starts)
//                    if isSessionStarted {
//                        TimelineView(.periodic(from: Date(), by: 1.0)) { context in
//                            Text(timeString(from: calculateCurrentDuration(at: context.date)))
//                                .font(.system(size: 56, weight: .light, design: .monospaced))
//                                .foregroundColor(.black)
//                        }
//                        .padding(.vertical, 20)
//                    }
//                    
//                    // Starting Page Display (after session starts)
//                    if isSessionStarted {
//                        VStack(spacing: 12) {
//                            Text("ÏãúÏûë ÌéòÏù¥ÏßÄ")
//                                .font(.subheadline)
//                                .foregroundColor(.gray)
//                            
//                            HStack {
//                                Image(systemName: "bookmark.fill")
//                                    .font(.system(size: 20))
//                                    .foregroundColor(Color(hex: "4CAF50"))
//                                
//                                if let session = localCurrentSession {
//                                    Text("\(session.startPage) ÌéòÏù¥ÏßÄ")
//                                        .font(.system(size: 28, weight: .medium))
//                                        .foregroundColor(.black)
//                                }
//                            }
//                            .padding(.vertical, 12)
//                            .padding(.horizontal, 24)
//                            .background(Color.gray.opacity(0.08))
//                            .cornerRadius(16)
//                            
//                            Text("ÎèÖÏÑúÏóê ÏßëÏ§ëÌïòÏÑ∏Ïöî")
//                                .font(.caption)
//                                .foregroundColor(.gray.opacity(0.8))
//                        }
//                    }
//                    
//                    // Distraction Counter (after session starts)
//                    if isSessionStarted {
//                        HStack(spacing: 8) {
//                            Image(systemName: "exclamationmark.triangle")
//                                .font(.system(size: 16))
//                                .foregroundColor(.gray)
//                            Text("Î∞©Ìï¥ ÏöîÏÜå: \(localDistractionCount)")
//                                .font(.body)
//                                .foregroundColor(.gray)
//                        }
//                        .padding(.horizontal, 20)
//                        .padding(.vertical, 12)
//                        .background(Color.gray.opacity(0.05))
//                        .cornerRadius(20)
//                    }
//                    
//                    Spacer()
//                    
//                    // Control Buttons
//                    VStack(spacing: 16) {
//                        // Pause/Resume and Distraction buttons (after session starts)
//                        if isSessionStarted {
//                            HStack {
//                                Button(action: {
//                                    // üî• Ï§ëÎ≥µ ÌÅ¥Î¶≠ Î∞©ÏßÄ
//                                    guard !isProcessingAction else { return }
//                                    Task {
//                                        await toggleReading()
//                                    }
//                                }) {
//                                    VStack(spacing: 8) {
//                                        Image(systemName: localIsPaused ? "play.fill" : "pause.fill")
//                                            .font(.title2)
//                                        Text(localIsPaused ? "Ïû¨Í∞ú" : "ÏùºÏãúÏ†ïÏßÄ")
//                                            .font(.caption)
//                                            .fontWeight(.medium)
//                                    }
//                                    .foregroundColor(localIsPaused ? .white : .black)
//                                    .frame(width: 100, height: 80)
//                                    .background(
//                                        RoundedRectangle(cornerRadius: 20)
//                                            .fill(localIsPaused ? Color.orange : Color.gray.opacity(0.1))
//                                            .shadow(color: .black.opacity(0.05), radius: 5)
//                                    )
//                                }
//                                .disabled(isProcessingAction)
//                                
//                                if !localIsPaused {
//                                    Button(action: {
//                                        // üî• Ï§ëÎ≥µ ÌÅ¥Î¶≠ Î∞©ÏßÄ
//                                        guard !isProcessingAction else { return }
//                                        Task {
//                                            await recordDistraction()
//                                        }
//                                    }) {
//                                        VStack(spacing: 8) {
//                                            Image(systemName: "hand.raised.fill")
//                                                .font(.title2)
//                                            Text("Î∞©Ìï¥ ÏöîÏÜå")
//                                                .font(.caption)
//                                                .fontWeight(.medium)
//                                        }
//                                        .foregroundColor(.black)
//                                        .frame(width: 100, height: 80)
//                                        .background(
//                                            RoundedRectangle(cornerRadius: 20)
//                                                .fill(Color.gray.opacity(0.1))
//                                                .shadow(color: .black.opacity(0.05), radius: 5)
//                                        )
//                                    }
//                                    .disabled(isProcessingAction)
//                                }
//                            }
//                            .padding(.horizontal, 40)
//                        }
//                        
//                        // Start Session / End Session button
//                        if !isSessionStarted {
//                            if isStartingSession {
//                                ProgressView()
//                                    .tint(.white)
//                                    .scaleEffect(1.5)
//                                    .frame(maxWidth: .infinity)
//                                    .frame(height: 56)
//                                    .background(Color(hex: "4CAF50"))
//                                    .cornerRadius(28)
//                            } else {
//                                Button(action: {
//                                    // üî• Ï§ëÎ≥µ ÌÅ¥Î¶≠ Î∞©ÏßÄ
//                                    guard !isProcessingAction else { return }
//                                    Task {
//                                        await startSession()
//                                    }
//                                }) {
//                                    Text("ÏÑ∏ÏÖò ÏãúÏûë")
//                                        .font(.body)
//                                        .fontWeight(.semibold)
//                                        .foregroundColor(.white)
//                                        .frame(maxWidth: .infinity)
//                                        .frame(height: 56)
//                                        .background(Color(hex: "4CAF50"))
//                                        .cornerRadius(28)
//                                        .shadow(color: Color(hex: "4CAF50").opacity(0.3), radius: 8, y: 4)
//                                }
//                                .disabled(isProcessingAction) // Ï≤òÎ¶¨ Ï§ëÏùº Îïå ÎπÑÌôúÏÑ±Ìôî
//                            }
//                        } else {
//                            Button(action: {
//                                // üî• Ï§ëÎ≥µ ÌÅ¥Î¶≠ Î∞©ÏßÄ
//                                guard !isProcessingAction else { return }
//                                Task {
//                                    await handleEndSession()
//                                }
//                            }) {
//                                Text("ÏÑ∏ÏÖò Ï¢ÖÎ£å")
//                                    .font(.body)
//                                    .fontWeight(.semibold)
//                                    .foregroundColor(.white)
//                                    .frame(maxWidth: .infinity)
//                                    .frame(height: 56)
//                                    .background(Color(hex: "4CAF50"))
//                                    .cornerRadius(28)
//                                    .shadow(color: Color(hex: "4CAF50").opacity(0.3), radius: 8, y: 4)
//                            }
//                            .disabled(isProcessingAction) // Ï≤òÎ¶¨ Ï§ëÏùº Îïå ÎπÑÌôúÏÑ±Ìôî
//                        }
//                    }
//                    .padding(.horizontal, 40)
//                    .padding(.bottom, 40)
//                }
//            }
//            .toolbar {
//                ToolbarItemGroup(placement: .keyboard) {
//                    Spacer()
//                    Button("ÏôÑÎ£å") {
//                        isStartingPageFocused = false
//                    }
//                }
//            }
//        }
//        .task {
//            // üî• Ï§ëÎ≥µ Ï¥àÍ∏∞Ìôî Î∞©ÏßÄ
//            if !hasInitialized {
//                await setupInitialState()
//            }
//        }
//        .interactiveDismissDisabled(isStartingSession || isProcessingAction || (isSessionStarted && localIsTracking))
//        .sheet(isPresented: $showingEndSession) {
//            EndSessionView(
//                frozenDuration: finalDuration,
//                onCompletion: {
//                    isPresented = false
//                    onSessionEnded()
//                }
//            )
//            .interactiveDismissDisabled()
//        }
//        .alert("ÏÑ∏ÏÖòÏùÑ Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?", isPresented: $showingCancelConfirmation) {
//            Button("Í≥ÑÏÜç ÏùΩÍ∏∞", role: .cancel) { }
//            Button("ÏÑ∏ÏÖò Ï∑®ÏÜå", role: .destructive) {
//                Task {
//                    await cancelSession()
//                }
//            }
//        } message: {
//            Text("Ï†ïÎßêÎ°ú Ïù¥ ÎèÖÏÑú ÏÑ∏ÏÖòÏùÑ Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå? ÏßÑÌñâÎ•†Ïù¥ Ï†ÄÏû•ÎêòÏßÄ ÏïäÏäµÎãàÎã§.")
//        }
//        .errorAlert($error)
//    }
//    
//    // MARK: - Private Methods
//    private func setupInitialState() async {
//        // üî• Ï§ëÎ≥µ Ï¥àÍ∏∞Ìôî Î∞©ÏßÄ
//        guard !hasInitialized else {
//            logger.warning("Already initialized, skipping")
//            return
//        }
//        hasInitialized = true
//        
//        logger.info("Setting up initial state for book: \(book.title)")
//        
//        // SessionManagerÏóêÏÑú ÌòÑÏû¨ ÏÑ∏ÏÖò Ï†ïÎ≥¥Îßå Í∞ÄÏ†∏Ïò§Í∏∞ (ÏÉÅÌÉú Í¥ÄÏ∞∞ ÏóÜÏù¥)
//        let currentSession = sessionManager.currentSession
//        
//        if let currentSession = currentSession,
//           currentSession.endTime == nil,
//           currentSession.book.objectID == book.objectID {
//            logger.info("Found existing active session for this book")
//            // Î°úÏª¨ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
//            localCurrentSession = currentSession
//            localIsTracking = true
//            localIsPaused = false // Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ï
//            localDistractionCount = Int(currentSession.distractionCount)
//            localStartTime = currentSession.startTime
//            isSessionStarted = true
//        } else {
//            logger.info("No active session found for this book, setting up new session")
//            isSessionStarted = false
//            startingPage = "\(book.currentPage)"
//            
//            // Small delay for better UX
//            try? await Task.sleep(nanoseconds: 500_000_000) // 0.5 seconds
//            isStartingPageFocused = true
//        }
//    }
//    
//    private func calculateCurrentDuration(at date: Date) -> TimeInterval {
//        guard localIsTracking, let startTime = localStartTime else { return 0 }
//        
//        if localIsPaused {
//            return localTotalReadingTime
//        } else {
//            return localTotalReadingTime + date.timeIntervalSince(startTime)
//        }
//    }
//    
//    private func startSession() async {
//        // üî• Í∞ïÌôîÎêú Ï§ëÎ≥µ Î∞©ÏßÄ Î°úÏßÅ
//        guard !isStartingSession,
//              !isSessionStarted,
//              !isProcessingAction else {
//            logger.warning("Session is already starting/started or action in progress")
//            return
//        }
//        
//        logger.info("Starting session for book: \(book.title)")
//        
//        // ÏÉÅÌÉú ÏÑ§Ï†ï
//        isProcessingAction = true
//        isStartingSession = true
//        
//        let startPage = Int(startingPage) ?? Int(book.currentPage)
//        
//        do {
//            localSessionCreated = true
//            
//            // SessionManagerÏóêÏÑú ÏÑ∏ÏÖò ÏãúÏûë (ÏÉÅÌÉú Í¥ÄÏ∞∞ ÏóÜÏù¥)
//            try await sessionManager.startSession(for: book, startingPage: startPage, location: "ÎèÖÏÑú Ï∂îÏ†Å")
//            
//            // ÏûëÏùÄ ÏßÄÏó∞ ÌõÑ Î°úÏª¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
//            try await Task.sleep(nanoseconds: 300_000_000) // 0.3 seconds
//            
//            // ÏÑ∏ÏÖò Ï†ïÎ≥¥ Îã§Ïãú Í∞ÄÏ†∏Ïò§Í∏∞ (Îã®Ïàú Ï°∞Ìöå)
//            if let newSession = sessionManager.currentSession,
//               newSession.book.objectID == book.objectID {
//                localCurrentSession = newSession
//                localIsTracking = true
//                localIsPaused = false
//                localDistractionCount = 0
//                localTotalReadingTime = 0
//                localStartTime = newSession.startTime
//                
//                logger.info("Session started successfully - keeping view open") // Îã®Ïùº ÏÑ±Í≥µ Î°úÍ∑∏
//                isSessionStarted = true
//            } else {
//                throw SessionError.sessionNotFound
//            }
//            
//            // Haptic feedback
//            let impactFeedback = UIImpactFeedbackGenerator(style: .medium)
//            impactFeedback.impactOccurred()
//            
//        } catch {
//            logger.error("Failed to start session: \(error.localizedDescription)")
//            localSessionCreated = false
//            self.error = TrackingError.sessionStartFailed(error)
//        }
//        
//        // ÏÉÅÌÉú Î¶¨ÏÖã
//        isStartingSession = false
//        isProcessingAction = false
//    }
//    
//    private func toggleReading() async {
//        // üî• Ï§ëÎ≥µ ÌÅ¥Î¶≠ Î∞©ÏßÄ
//        guard !isProcessingAction else { return }
//        isProcessingAction = true
//        
//        do {
//            if localIsPaused {
//                logger.info("Resuming session")
//                try await sessionManager.resumeSession()
//                localIsPaused = false
//                localStartTime = Date() // Ïû¨Í∞ú ÏãúÍ∞Ñ Í∏∞Î°ù
//            } else {
//                logger.info("Pausing session")
//                try await sessionManager.pauseSession()
//                
//                // ÏùºÏãúÏ†ïÏßÄ Ïãú ÌòÑÏû¨ÍπåÏßÄÏùò ÏãúÍ∞Ñ ÎàÑÏ†Å
//                if let startTime = localStartTime {
//                    localTotalReadingTime += Date().timeIntervalSince(startTime)
//                }
//                localIsPaused = true
//            }
//            
//            // Haptic feedback
//            let impactFeedback = UIImpactFeedbackGenerator(style: .light)
//            impactFeedback.impactOccurred()
//            
//        } catch {
//            logger.error("Failed to toggle reading state: \(error.localizedDescription)")
//            self.error = TrackingError.sessionToggleFailed(error)
//        }
//        
//        isProcessingAction = false
//    }
//    
//    private func recordDistraction() async {
//        // üî• Ï§ëÎ≥µ ÌÅ¥Î¶≠ Î∞©ÏßÄ
//        guard !isProcessingAction else { return }
//        isProcessingAction = true
//        
//        do {
//            logger.info("Recording distraction")
//            try await sessionManager.recordDistraction()
//            
//            // Î°úÏª¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
//            localDistractionCount += 1
//            
//            // Haptic feedback
//            let impactFeedback = UIImpactFeedbackGenerator(style: .medium)
//            impactFeedback.impactOccurred()
//            
//        } catch {
//            logger.error("Failed to record distraction: \(error.localizedDescription)")
//            self.error = TrackingError.distractionRecordFailed(error)
//        }
//        
//        isProcessingAction = false
//    }
//    
//    private func handleEndSession() async {
//        // üî• Ï§ëÎ≥µ ÌÅ¥Î¶≠ Î∞©ÏßÄ
//        guard !isProcessingAction else { return }
//        isProcessingAction = true
//        
//        logger.info("Handling end session")
//        
//        do {
//            finalDuration = calculateCurrentDuration(at: Date())
//            
//            if !localIsPaused {
//                try await sessionManager.pauseSession()
//                localIsPaused = true
//            }
//            
//            showingEndSession = true
//            
//        } catch {
//            logger.error("Failed to handle end session: \(error.localizedDescription)")
//            self.error = TrackingError.sessionEndFailed(error)
//        }
//        
//        isProcessingAction = false
//    }
//    
//    private func cancelSession() async {
//        // üî• Ï§ëÎ≥µ ÌÅ¥Î¶≠ Î∞©ÏßÄ
//        guard !isProcessingAction else { return }
//        isProcessingAction = true
//        
//        logger.info("Canceling session")
//        
//        do {
//            try await sessionManager.cancelSession()
//            localSessionCreated = false
//            
//            // Î°úÏª¨ ÏÉÅÌÉú Î¶¨ÏÖã
//            localCurrentSession = nil
//            localIsTracking = false
//            localIsPaused = false
//            localDistractionCount = 0
//            localTotalReadingTime = 0
//            localStartTime = nil
//            
//            isPresented = false
//            onSessionEnded()
//            
//        } catch {
//            logger.error("Failed to cancel session: \(error.localizedDescription)")
//            self.error = TrackingError.sessionCancelFailed(error)
//        }
//        
//        isProcessingAction = false
//    }
//    
//    private func timeString(from interval: TimeInterval) -> String {
//        let hours = Int(interval) / 3600
//        let minutes = Int(interval) % 3600 / 60
//        let seconds = Int(interval) % 60
//        
//        if hours > 0 {
//            return String(format: "%02d:%02d:%02d", hours, minutes, seconds)
//        } else {
//            return String(format: "%02d:%02d", minutes, seconds)
//        }
//    }
//}
//
//// MARK: - Error Types
//enum TrackingError: LocalizedError {
//    case sessionStartFailed(Error)
//    case sessionToggleFailed(Error)
//    case distractionRecordFailed(Error)
//    case sessionEndFailed(Error)
//    case sessionCancelFailed(Error)
//    
//    var errorDescription: String? {
//        switch self {
//        case .sessionStartFailed(let error):
//            return "ÏÑ∏ÏÖò ÏãúÏûë Ïã§Ìå®: \(error.localizedDescription)"
//        case .sessionToggleFailed(let error):
//            return "ÏÑ∏ÏÖò ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïã§Ìå®: \(error.localizedDescription)"
//        case .distractionRecordFailed(let error):
//            return "Î∞©Ìï¥ ÏöîÏÜå Í∏∞Î°ù Ïã§Ìå®: \(error.localizedDescription)"
//        case .sessionEndFailed(let error):
//            return "ÏÑ∏ÏÖò Ï¢ÖÎ£å Ïã§Ìå®: \(error.localizedDescription)"
//        case .sessionCancelFailed(let error):
//            return "ÏÑ∏ÏÖò Ï∑®ÏÜå Ïã§Ìå®: \(error.localizedDescription)"
//        }
//    }
//}
//
//// MARK: - Error Alert Extension
//extension View {
//    func errorAlert(_ error: Binding<TrackingError?>) -> some View {
//        alert("Ïò§Î•ò", isPresented: .constant(error.wrappedValue != nil)) {
//            Button("ÌôïÏù∏") {
//                error.wrappedValue = nil
//            }
//        } message: {
//            Text(error.wrappedValue?.errorDescription ?? "Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.")
//        }
//    }
//}
//
//#Preview {
//    TrackingOverlayView(
//        isPresented: .constant(true),
//        book: Book(),
//        onSessionEnded: {}
//    )
//    .environment(\.managedObjectContext, PersistenceController.preview.container.viewContext)
//}
